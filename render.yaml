databases:
  - name: ijaa-user-db
    databaseName: ijaa_users
    user: ijaa_user
    plan: free
  - name: ijaa-event-db
    databaseName: ijaa_events
    user: ijaa_event
    plan: free
  - name: ijaa-file-db
    databaseName: ijaa_files
    user: ijaa_file
    plan: free

services:
  # Discovery Service (Eureka Server) - Must start first for service discovery
  - type: web
    name: ijaa-discovery-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd discovery-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd discovery-service && java -jar target/discovery-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8761
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_PREFER_IP_ADDRESS
        value: false
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-discovery-service.onrender.com

  # Config Service - Must start second for configuration management
  - type: web
    name: ijaa-config-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd config-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd config-service && java -jar target/config-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8888
      - key: SPRING_CLOUD_CONFIG_SERVER_GIT_URI
        value: https://github.com/mesahal/ijaa.git
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-config-service.onrender.com

  # User Service - Core user management and authentication
  - type: web
    name: ijaa-user-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd user-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd user-service && java -jar target/user-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8081
      - key: SPRING_DATASOURCE_URL
        value: postgresql://ijaa_user:${ijaa-user-db.password}@${ijaa-user-db.host}:${ijaa-user-db.port}/ijaa_users
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-user-service.onrender.com
      - key: JWT_SECRET
        generateValue: true
      - key: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
        value: 10
      - key: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
        value: 5
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT
        value: 30000
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: update
      - key: SPRING_JPA_SHOW_SQL
        value: false
      - key: SPRING_SQL_INIT_MODE
        value: always
      - key: SPRING_SQL_INIT_SCHEMA_LOCATIONS
        value: classpath:db/schema.sql
      - key: SPRING_SQL_INIT_DATA_LOCATIONS
        value: classpath:db/data.sql
      - key: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: health,info,metrics
      - key: MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS
        value: always

  # Event Service - Event management and advanced search
  - type: web
    name: ijaa-event-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd event-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd event-service && java -jar target/event-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8082
      - key: SPRING_DATASOURCE_URL
        value: postgresql://ijaa_event:${ijaa-event-db.password}@${ijaa-event-db.host}:${ijaa-event-db.port}/ijaa_events
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-event-service.onrender.com
      - key: JWT_SECRET
        generateValue: true
      - key: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
        value: 10
      - key: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
        value: 5
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT
        value: 30000
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: update
      - key: SPRING_JPA_SHOW_SQL
        value: false
      - key: SPRING_SQL_INIT_MODE
        value: always
      - key: SPRING_SQL_INIT_SCHEMA_LOCATIONS
        value: classpath:db/schema.sql
      - key: SPRING_SQL_INIT_DATA_LOCATIONS
        value: classpath:db/data.sql
      - key: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: health,info,metrics
      - key: MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS
        value: always

  # File Service - File upload and management
  - type: web
    name: ijaa-file-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd file-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd file-service && java -jar target/file-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8083
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-file-service.onrender.com
      - key: JWT_SECRET
        generateValue: true
      - key: SPRING_DATASOURCE_URL
        value: postgresql://ijaa_file:${ijaa-file-db.password}@${ijaa-file-db.host}:${ijaa-file-db.port}/ijaa_files
      - key: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
        value: 10
      - key: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
        value: 5
      - key: SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT
        value: 30000
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: update
      - key: SPRING_JPA_SHOW_SQL
        value: false
      - key: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: health,info,metrics
      - key: MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS
        value: always

  # Gateway Service - API Gateway and routing (must start last)
  - type: web
    name: ijaa-gateway-service
    runtime: java
    plan: free
    autoDeploy: true
    buildCommand: cd gateway-service && mvn clean package -Dmaven.test.skip=true
    startCommand: cd gateway-service && java -jar target/gateway-service-0.0.1-SNAPSHOT.jar
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8080
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://ijaa-discovery-service.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        value: ijaa-gateway-service.onrender.com
      - key: JWT_SECRET
        generateValue: true
      - key: SPRING_CLOUD_GATEWAY_ROUTES_0_ID
        value: user-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_0_URI
        value: lb://ijaa-user-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_0_PREDICATES_0
        value: Path=/ijaa/api/v1/user/**
      - key: SPRING_CLOUD_GATEWAY_ROUTES_1_ID
        value: event-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_1_URI
        value: lb://ijaa-event-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_1_PREDICATES_0
        value: Path=/ijaa/api/v1/user/events/**
      - key: SPRING_CLOUD_GATEWAY_ROUTES_2_ID
        value: file-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_2_URI
        value: lb://ijaa-file-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_2_PREDICATES_0
        value: Path=/ijaa/api/v1/users/**
      - key: SPRING_CLOUD_GATEWAY_ROUTES_3_ID
        value: admin-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_3_URI
        value: lb://ijaa-user-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_3_PREDICATES_0
        value: Path=/ijaa/api/v1/admin/**
      - key: SPRING_CLOUD_GATEWAY_ROUTES_4_ID
        value: public-files
      - key: SPRING_CLOUD_GATEWAY_ROUTES_4_URI
        value: lb://ijaa-file-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_4_PREDICATES_0
        value: Path=/ijaa/api/v1/events/*/banner/file/**
      - key: SPRING_CLOUD_GATEWAY_ROUTES_5_ID
        value: feature-flags
      - key: SPRING_CLOUD_GATEWAY_ROUTES_5_URI
        value: lb://ijaa-user-service
      - key: SPRING_CLOUD_GATEWAY_ROUTES_5_PREDICATES_0
        value: Path=/ijaa/api/v1/admin/feature-flags/*/enabled
